# Istio networking configuration
# TLS is configured for cert-manager integration

gateway:
  name: platform-gateway
  namespace: service-mesh
  servers:
    - name: https
      port: 443
      protocol: HTTPS
      # TLS mode: SIMPLE for cert-manager managed certs
      tls:
        mode: SIMPLE
        credentialName: platform-tls-cert
      hosts:
        - "*.example.com"
    - name: http-redirect
      port: 80
      protocol: HTTP
      tls:
        httpsRedirect: true
      hosts:
        - "*.example.com"

# TLS certificate configuration (cert-manager compatible)
tls:
  enabled: true
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  secretName: platform-tls-cert
  hosts:
    - "*.example.com"

# VirtualService definitions for each service
virtualServices:
  harbor:
    enabled: true
    host: harbor.example.com
    gateway: platform-gateway
    destination:
      host: harbor-core.harbor.svc.cluster.local
      port: 80
  nexus:
    enabled: true
    host: nexus.example.com
    gateway: platform-gateway
    destination:
      host: nexus-nexus-repository-manager.nexus.svc.cluster.local
      port: 8081
  argocd:
    enabled: true
    host: argocd.example.com
    gateway: platform-gateway
    destination:
      host: argocd-server.argocd.svc.cluster.local
      port: 443
  kiali:
    enabled: true
    host: kiali.example.com
    gateway: platform-gateway
    destination:
      host: kiali.kiali.svc.cluster.local
      port: 20001
  oauth2proxy:
    enabled: true
    host: auth.example.com
    gateway: platform-gateway
    destination:
      host: oauth2-proxy.oauth2-proxy.svc.cluster.local
      port: 80

# DestinationRule definitions
destinationRules:
  harbor:
    enabled: true
    host: harbor-core.harbor.svc.cluster.local
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 100
        http:
          h2UpgradePolicy: DEFAULT
          http1MaxPendingRequests: 100
          http2MaxRequests: 1000
      tls:
        mode: ISTIO_MUTUAL
  nexus:
    enabled: true
    host: nexus-nexus-repository-manager.nexus.svc.cluster.local
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 100
        http:
          h2UpgradePolicy: DEFAULT
          http1MaxPendingRequests: 100
          http2MaxRequests: 1000
      tls:
        mode: ISTIO_MUTUAL
  argocd:
    enabled: true
    host: argocd-server.argocd.svc.cluster.local
    trafficPolicy:
      tls:
        mode: DISABLE
  kiali:
    enabled: true
    host: kiali.kiali.svc.cluster.local
    trafficPolicy:
      tls:
        mode: ISTIO_MUTUAL
